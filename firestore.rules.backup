rules_version = '2';
service cloud.firestore {
  match /databases/{database}/documents {
    
    // Helper function to check if user is authenticated
    function isAuthenticated() {
      return request.auth != null;
    }
    
    // Helper function to check if user is admin
    function isAdmin() {
      return isAuthenticated() && get(/databases/$(database)/documents/users/$(request.auth.uid)).data.role == 'admin';
    }
    
    // Users collection
    match /users/{userId} {
      // Anyone can read user profiles
      allow read: if true;
      // Users can only create/update their own profile
      allow create: if isAuthenticated() && request.auth.uid == userId;
      allow update: if isAuthenticated() && (request.auth.uid == userId || isAdmin());
      // Only admins can delete users
      allow delete: if isAdmin();
    }
    
    // Predictions collection
    match /predictions/{predictionId} {
      // Anyone can read approved and active predictions
      allow read: if true;
      // Authenticated users can create predictions (goes to pending status for admin approval)
      // Required fields: question, optionA, optionB, categoryId, endDate, creatorId, status
      // Optional fields: imageUrl, sourceLink
      allow create: if isAuthenticated() 
                    && request.resource.data.creatorId == request.auth.uid
                    && request.resource.data.status == 'pending'
                    && request.resource.data.isApproved == false;
      // Creators can update their own pending predictions (e.g., add imageUrl after upload)
      // Admins can update any prediction (approve, resolve, etc.)
      allow update: if isAuthenticated() && 
                       (request.auth.uid == resource.data.creatorId && resource.data.status == 'pending')
                    || isAdmin();
      // Only admins can delete predictions
      allow delete: if isAdmin();
    }
    
    // Votes collection
    match /votes/{voteId} {
      // Users can read their own votes and anyone can read for statistics
      allow read: if true;
      // Users can create votes (one per prediction)
      allow create: if isAuthenticated() && request.resource.data.userId == request.auth.uid;
      // Votes cannot be updated or deleted by users, only admins for corrections
      allow update: if isAdmin();
      allow delete: if isAdmin();
    }
    
    // Categories collection
    match /categories/{categoryId} {
      // Anyone can read categories
      allow read: if true;
      // Only admins can modify categories
      allow create, update, delete: if isAdmin();
    }
    
    // Comments collection
    match /comments/{commentId} {
      // Anyone can read comments
      allow read: if true;
      // Authenticated users can create comments
      allow create: if isAuthenticated() && request.resource.data.userId == request.auth.uid;
      // Users can update/delete their own comments
      allow update, delete: if isAuthenticated() && resource.data.userId == request.auth.uid;
    }
    
    // Follows collection
    match /follows/{followId} {
      // Anyone can read follows (for follower counts)
      allow read: if true;
      // Users can create follows (following someone)
      allow create: if isAuthenticated() && request.resource.data.followerId == request.auth.uid;
      // Users can delete their own follows (unfollowing)
      allow delete: if isAuthenticated() && resource.data.followerId == request.auth.uid;
      // Follows cannot be updated
      allow update: if false;
    }
    
    // Analytics collection (optional)
    match /analytics/{entryId} {
      // Only admins can read analytics
      allow read: if isAdmin();
      // System can create analytics entries
      allow create: if isAuthenticated();
      // Cannot be modified
      allow update, delete: if false;
    }
    
    // Reports collection (optional)
    match /reports/{reportId} {
      // Only admins can read reports
      allow read: if isAdmin();
      // Authenticated users can create reports
      allow create: if isAuthenticated();
      // Cannot be modified
      allow update, delete: if false;
    }
    
    // Bookmarks collection
    match /bookmarks/{bookmarkId} {
      // Users can read their own bookmarks
      allow read: if isAuthenticated() && resource.data.userId == request.auth.uid;
      // Users can create bookmarks for themselves
      allow create: if isAuthenticated() && request.resource.data.userId == request.auth.uid;
      // Users can delete their own bookmarks
      allow delete: if isAuthenticated() && resource.data.userId == request.auth.uid;
      // Bookmarks cannot be updated (only create/delete)
      allow update: if false;
    }
  }
}
